# we_ports_micro Financial Logic Explanation

> üåê Chinese Version: [README_FIN_cn.md](README_FIN_cn.md)

This document focuses on the core financial models and calculation logic of the project, detailing the mathematical principles and implementation details of stock price simulation, option pricing, and portfolio valuation.


## I. Overview of Core Financial Models

The project adopts two core financial models to achieve real-time valuation:
- **Geometric Brownian Motion (GBM)**: Simulates the random fluctuation of stock prices
- **Black-Scholes Model**: Calculates the theoretical price of options

Using the above models, the system periodically generates market data snapshots (default interval: 500ms), calculates the market value of positions, and aggregates the total Net Asset Value (NAV) of the portfolio.


## II. Stock Price Simulation: Geometric Brownian Motion (GBM)

Stock price fluctuations are simulated using the Geometric Brownian Motion model, whose core idea is: the return rate of stock prices follows a normal distribution, and price changes are proportional to the current price.

### Mathematical Formula
Price change rate formula:
$$
\frac{\Delta S}{S} = \mu \cdot \frac{\Delta t}{T_{year}} + \sigma \cdot \epsilon \cdot \sqrt{\frac{\Delta t}{T_{year}}}
$$

Derived, the stock price at time $t$ is:
$$
S_t = S_{t-1} \cdot \left(1 + \mu \cdot \frac{\Delta t}{T_{year}} + \sigma \cdot \epsilon \cdot \sqrt{\frac{\Delta t}{T_{year}}}\right)
$$

### Parameter Explanation
| Parameter | Meaning | Value/Source |
|-----------|---------|--------------|
| $S$       | Stock price | Initial price configurable (e.g., AAPL=110.0, TELSA=450.0) |
| $\mu$     | Expected annual return rate | Configurable per stock (AAPL=0.08, TELSA=0.12, default=0.05) |
| $\sigma$  | Annual volatility | Configurable per stock (AAPL=0.2, TELSA=0.3, default=0.2) |
| $\Delta t$| Time interval (seconds) | Calculated based on the time difference between two price updates |
| $T_{year}$| Annual seconds | Fixed at 7257600 (calculated as 365 days √ó 24 hours √ó 3600 seconds) |
| $\epsilon$| Standard normal distribution random variable | Generated by a random number generator ($N(0,1)$) |

### Implementation Details
- The initial price is used when generating the price for the first time (configured via `portfolio.marketdata.initial-price.{TICKER}`)
- For non-first-time generation, $\Delta t$ is calculated based on the previous price and timestamp, then substituted into the GBM formula
- Price precision is fixed to 2 decimal places, and non-negativity is ensured (minimum 0.01)
- Code implementation: `GBMPricingStrategy.generatePrice()`


## III. Option Pricing: Black-Scholes Model

Option prices are calculated using the Black-Scholes model, which is based on the no-arbitrage principle and assumes that the underlying asset price follows geometric Brownian motion.

### Core Formulas

#### Call Option Price
$$
C = S \cdot N(d_1) - K \cdot e^{-rT} \cdot N(d_2)
$$

#### Put Option Price
$$
P = K \cdot e^{-rT} \cdot N(-d_2) - S \cdot N(-d_1)
$$

#### Auxiliary Calculations
$$
d_1 = \frac{\ln(S/K) + (r + 0.5\sigma^2)T}{\sigma\sqrt{T}}
$$
$$
d_2 = d_1 - \sigma\sqrt{T}
$$
$$
N(x) = \frac{1}{\sqrt{2\pi}} \int_{-\infty}^{x} e^{-t^2/2} dt \quad \text{(Standard Normal Cumulative Distribution Function)}
$$

### Parameter Explanation
| Parameter | Meaning | Value/Source |
|-----------|---------|--------------|
| $S$       | Underlying stock price | Generated in real-time by the GBM model |
| $K$       | Option strike price | Predefined option contract attribute |
| $r$       | Risk-free rate | Configurable value (default=0.02) |
| $T$       | Time to maturity (years) | Calculated based on the option's maturity date and current time |
| $\sigma$  | Underlying stock volatility | Consistent with $\sigma$ of the stock in the GBM model |
| $N(\cdot)$| Standard normal CDF | Implemented via approximation algorithm in code |

### Implementation Details
- Parameter validation: Returns 0 if $S \leq 0$, $K \leq 0$, or $T \leq 0$
- Price precision is fixed to 2 decimal places, and non-negativity is ensured (returns 0 if the calculated result is negative)
- Code implementation: `BlackScholesPricingService.calculate()`


## IV. Portfolio Valuation Logic

The total Net Asset Value (NAV) of the portfolio is the sum of the market values of all positions. The calculation rules for position market value are as follows:

1. **Stock Positions**:  
   Market Value = Real-time price of the underlying stock √ó Position quantity  
   (Price source: `MarketData` generated by the GBM model)

2. **Option Positions**:  
   Market Value = Theoretical option price (calculated by Black-Scholes) √ó Position quantity √ó Contract multiplier  
   (Contract multiplier configuration: `portfolio.option.contract-multiplier`, default=1)

3. **Real-time Update Mechanism**:  
   - Generates a market data snapshot every 500ms  
   - Compares with the previous snapshot to record stocks with price changes  
   - Recalculates the market value of all positions based on the latest prices and aggregates the NAV  
   - Code implementation: `ReactivePortfolioValuator.calculateRealTimeValuation()`


## V. Key Financial Parameter Configuration

All financial parameters can be configured via `application.properties`. Core parameters are as follows:

```properties
# Risk-free rate (used in Black-Scholes model)
portfolio.option.risk-free-rate=0.02

# Stock expected return rate Œº (used in GBM model)
portfolio.marketdata.mu.AAPL=0.08
portfolio.marketdata.mu.TELSA=0.12

# Stock volatility œÉ (shared by GBM and Black-Scholes models)
portfolio.marketdata.sigma.AAPL=0.2
portfolio.marketdata.sigma.TELSA=0.3

# Initial stock prices
portfolio.marketdata.initial-price.AAPL=110.0
portfolio.marketdata.initial-price.TELSA=450.0

# Option contract multiplier
portfolio.option.contract-multiplier=1
```


## VI. Model Validation

The project verifies the correctness of financial models through unit tests:

- **Black-Scholes Model Tests**:  
  Validates pricing for at-the-money, in-the-money, and out-of-the-money options. For example:  
  - When $S=100$, $K=100$, $T=1$, $r=0.02$, $\sigma=0.2$, the theoretical call option price is approximately 8.90, and the put option price is approximately 7.02 (`BlackScholesPricingServiceTest`)

- **GBM Model Tests**:  
  Verifies price non-negativity, precision (2 decimal places), and formula correctness, ensuring price changes conform to GBM theory under the same parameters (`GBMPricingStrategyTest`)